Bootstrap: docker
From: condaforge/miniforge3:25.3.1-0
Stage: spython-base

%files
. .
%post
# Use the official Python 3.12 slim image as base



apt-get update && apt-get install -y git-all wget bzip2 && rm -rf /var/lib/apt/lists/*
# # ARG MINICONDA_VERSION="latest"
# # RUN wget https://repo.anaconda.com/miniconda/Miniconda3-${MINICONDA_VERSION}-Linux-x86_64.sh -O /tmp/miniconda.sh

# # # Install Miniconda silently to /opt/conda
# # RUN bash /tmp/miniconda.sh -b -p /opt/conda && \
# #     rm /tmp/miniconda.sh

# # Add Conda to PATH
PATH="/opt/conda/bin:$PATH"


# # RUN conda config --add channels conda-forge
conda config --add channels bioconda
# # RUN conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
# # RUN conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

mamba create -y -n bohra3-csvtk csvtk=0.33

mamba create -y -n bohra3-mash -c bioconda mash csvtk

mamba create -y -n bohra3-spades spades=3.15.2 python=3.8.16 csvtk

mamba create -y -n bohra3-skesa skesa csvtk

mamba create -y -n bohra3-seqtk seqtk csvtk

mamba create -y -n bohra3-iqtree iqtree=2.2.0 csvtk gotree=0.4.5 snp-sites=2.5.1

mamba create -y -n bohra3-quicktree quicktree=2.5 gotree=0.4.5 csvtk

mamba create -y -n bohra3-prokka prokka csvtk

mamba create -y -n bohra3-snippy snpeff=5.0 snippy=4.4.5 snp-sites=2.5.1 csvtk

mamba create -y -n bohra3-shovill shovill=1.1.0 spades=3.15.2 python=3.8.16 csvtk

mamba create -y -n bohra3-mlst mlst=2.19.0 csvtk pandas numpy

mamba create -y -n bohra3-kraken2 kraken2=2.1.2 csvtk

mamba create -y -n bohra3-mob_suite mob_suite=3.1.9 csvtk

# SHELL ["mamba", "run", "-n", "bohra3-mob_suite", "/bin/bash", "-c"]
# RUN mob_init

mamba create -y -n bohra3-panaroo panaroo python=3.10 biopython=1.81 csvtk

mamba create -y -n bohra3-abritamr abritamr=1.0.19 csvtk
mamba run -n bohra3-abritamr pip3 install --force-reinstall 'git+https://github.com/MDU-PHL/abritamr@int_bug'

mamba create -y -n bohra3-gubbins gubbins=2.4.1 snp-sites=2.5.1 csvtk

mamba create -y -n bohra3-snpdists snp-dists=0.8.2 csvtk

mamba create -y -n bohra3-ectyper ectyper csvtk

mamba create -y -n bohra3-emmtyper emmtyper csvtk

mamba create -y -n bohra3-kleborate kleborate=2.3.2  csvtk

mamba create -y -n bohra3-kmc kmc csvtk

mamba create -y -n bohra3-lissero lissero csvtk

mamba create -y -n bohra3-meningotype meningotype csvtk

mamba create -y -n bohra3-ngmaster ngmaster csvtk

mamba create -y -n bohra3-stype sistr_cmd=1.1.1 csvtk

# RUN mamba shell init --shell bash
mamba run -n bohra3-stype pip3 install 'git+https://github.com/MDU-PHL/salmonella_typing'

mamba create -y -n bohra3-tbtamr python=3.10 tbtamr=1.0.3 csvtk
mamba run -n bohra3-tbtamr pip3 install pysam joblib tqdm pydantic requests git+https://github.com/jodyphelan/pathogen-profiler@v4.3.0


mamba create -y -n bohra3-veryfasttree veryfasttree csvtk gotree=0.4.5

mamba create -y -n bohra3-shigapass blast=2.16.0 csvtk

mamba create -y -n bohra3-sonneitype mykrobe pandas csvtk

mamba create -y -n bohra3-ska2 ska2 csvtk pandas

mamba create -y -n bohra3-core-snp-filter core-snp-filter csvtk

mamba create -y -n bohra3-cluster numpy pandas scikit-learn csvtk

mamba create -y -n bohra3-classify-pangenome r-data.table=1.17.6 r-ggplot2=3.5.2 r-optparse=1.7.5

mamba create -y -n bohra3-fastp fastp csvtk

mamba create -y -n bohra3-seqkit seqkit==2.1.0 csvtk

mamba create -y -n bohra3-lissero lissero python=3.11 csvtk


mamba  create -y -n bohra3-datasmryzr python=3.11 csvtk
mamba run -n bohra3-datasmryzr pip3  install git+https://github.com/kristyhoran/datasmryzr

mamba env create -f environment.yml

mamba run -n bohra3 pip3 install .
# mamba activate -n bohra3 bohra run full --help
# RUN bohra check --install-deps --no-databases
apt-get update && apt-get install -y tini vim less

conda clean -a -y

mamba clean -a -y
which tini
TINI_SUBREAPER=true

# Create a wrapper script
echo '#!/bin/bash\n\
source /opt/conda/etc/profile.d/conda.sh\n\
conda activate bohra3\n\
exec "$@"' > /entrypoint.sh && chmod +x /entrypoint.sh

mkdir -p /home/bohra/workdir && chmod 777 -R /home/bohra/workdir
ls -lathr /home/bohra/workdir
BOHRA_WD=/home/bohra/workdir
# WORKDIR /home/bohra/workdir
%environment
export PATH="/opt/conda/bin:$PATH"
export TINI_SUBREAPER=true
export BOHRA_WD=/home/bohra/workdir
%runscript
exec /usr/bin/tini -- /entrypoint.sh "$@"
%startscript
exec /usr/bin/tini -- /entrypoint.sh "$@"
